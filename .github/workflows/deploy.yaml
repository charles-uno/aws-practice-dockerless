name: deploy

on: [push, pull_request]

# NOTE: the key is stored as a secret on GitHub. the address is not sensitive
env:
  AWS_USERNAME: ec2-user
  AWS_ADDRESS: "3.99.187.151"

jobs:
  update_files:
    runs-on: ubuntu-latest
    steps:
      - name: repo checkout
        uses: actions/checkout@v2
      - name: clean up previous workdir
        uses: fifsky/ssh-action@master
        with:
          command: |
            rm -rf ~/workdir ||:
            mkdir -p ~//workdir
          host: $AWS_ADDRESS
          user: $AWS_USERNAME
          key: ${{secrets.AWS_KEY}}

      # NOTE: https://github.com/appleboy/ssh-action/issues/80
      - name: copy files over to aws
        uses: appleboy/scp-action@master
        with:
          host: ${{secrets.AWS_ADDRESS}}
          port: 22
          username: $AWS_USERNAME
          key: ${{secrets.OPENSSH_KEY}}
          source: "requirements.txt"
          target: "~/workdir/"


